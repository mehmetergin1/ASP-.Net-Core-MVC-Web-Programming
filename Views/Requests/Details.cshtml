@model CivicRequestPortal.Models.ServiceRequest
@{
    ViewData["Title"] = "Şikayet Detayları";
}

@section Styles {
    @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
    {
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    }
}

<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Şikayet Detayları</h3>
                <span class="badge bg-@(Model.Status?.BadgeColor ?? "secondary") fs-6">
                    @Model.Status?.Name
                </span>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Şikayet Bilgileri</h5>
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">Şikayet Numarası:</th>
                                <td><strong>@Model.RequestNumber</strong></td>
                            </tr>
                            <tr>
                                <th>Başlık:</th>
                                <td>@Model.Title</td>
                            </tr>
                            <tr>
                                <th>Açıklama:</th>
                                <td>@Model.Description</td>
                            </tr>
                            <tr>
                                <th>Kategori:</th>
                                <td>@Model.Category?.Name</td>
                            </tr>
                            <tr>
                                <th>Öncelik:</th>
                                <td>
                                    @if (Model.Priority == 1)
                                    {
                                        <span class="badge bg-danger">Yüksek</span>
                                    }
                                    else if (Model.Priority == 2)
                                    {
                                        <span class="badge bg-warning">Orta</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-info">Düşük</span>
                                    }
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Durum Bilgileri</h5>
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">Gönderilme Tarihi:</th>
                                <td>@Model.SubmittedAt.ToString("dd.MM.yyyy HH:mm")</td>
                            </tr>
                            @if (Model.AssignedAt.HasValue)
                            {
                                <tr>
                                    <th>Atanma Tarihi:</th>
                                    <td>@Model.AssignedAt.Value.ToString("dd.MM.yyyy HH:mm")</td>
                                </tr>
                            }
                            @if (Model.ResolvedAt.HasValue)
                            {
                                <tr>
                                    <th>Çözülme Tarihi:</th>
                                    <td>@Model.ResolvedAt.Value.ToString("dd.MM.yyyy HH:mm")</td>
                                </tr>
                            }
                            @if (Model.SLADeadline.HasValue)
                            {
                                <tr>
                                    <th>Hedef Çözüm Tarihi:</th>
                                    <td>
                                        @Model.SLADeadline.Value.ToString("dd.MM.yyyy HH:mm")
                                        @if (Model.IsSLABreached)
                                        {
                                            <span class="badge bg-danger ms-2">Süre Aşıldı</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </table>
                    </div>
                </div>

                @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
                {
                    <div class="mb-4">
                        <h5>Konum</h5>
                        <p><strong>Adres:</strong> @Model.Address</p>
                        <div id="map" style="height: 300px; width: 100%; border: 1px solid #ddd; border-radius: 5px;"></div>
                    </div>
                }

                @if (Model.Assignments.Any(a => a.IsActive))
                {
                    <div class="mb-4">
                        <h5>Atanan Personel</h5>
                        <ul class="list-group">
                            @foreach (var assignment in Model.Assignments.Where(a => a.IsActive))
                            {
                                <li class="list-group-item">
                                    <strong>@assignment.AssignedToUser?.FirstName @assignment.AssignedToUser?.LastName</strong>
                                    <br />
                                    <small class="text-muted">Atanma: @assignment.AssignedAt.ToString("dd.MM.yyyy HH:mm")</small>
                                    @if (!string.IsNullOrEmpty(assignment.Notes))
                                    {
                                        <br />
                                        <small>Not: @assignment.Notes</small>
                                    }
                                </li>
                            }
                        </ul>
                    </div>
                }

                <div class="mb-4">
                    <h5>Güncellemeler</h5>
                    <div class="timeline">
                        @foreach (var update in Model.Updates.Where(u => !u.IsInternal).OrderByDescending(u => u.CreatedAt))
                        {
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <strong>@update.User?.FirstName @update.User?.LastName</strong>
                                        <small class="text-muted">@update.CreatedAt.ToString("dd.MM.yyyy HH:mm")</small>
                                    </div>
                                    <p class="mb-0 mt-2">@update.Comment</p>
                                </div>
                            </div>
                        }
                        @if (!Model.Updates.Any(u => !u.IsInternal))
                        {
                            <p class="text-muted">Henüz herkese açık bir güncelleme yok.</p>
                        }
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a asp-action="Track" class="btn btn-secondary">Geri Dön</a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
    {
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Use .ToString() with InvariantCulture for decimal values in JavaScript to avoid comma issues
                var lat = @Model.Latitude.Value.ToString(System.Globalization.CultureInfo.InvariantCulture);
                var lon = @Model.Longitude.Value.ToString(System.Globalization.CultureInfo.InvariantCulture);

                var map = L.map('map').setView([lat, lon], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                
                L.marker([lat, lon]).addTo(map)
                    .bindPopup('@Html.Raw(Model.Address?.Replace("'", "\\'"))').openPopup();
            });
        </script>
    }
}
