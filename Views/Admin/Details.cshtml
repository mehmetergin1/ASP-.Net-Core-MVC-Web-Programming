@model CivicRequestPortal.Models.ServiceRequest
@{
    ViewData["Title"] = "Şikayet Detayları - Admin";
}

@section Styles {
    @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
    {
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    }
}

<div class="row">
    <div class="col-md-12">
        <div class="card shadow mb-4">
            <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                <h3 class="mb-0">Şikayet Detayları</h3>
                <span class="badge bg-@(Model.Status?.BadgeColor ?? "secondary") fs-6">
                    @Model.Status?.Name
                </span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Şikayet Bilgileri</h5>
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">Şikayet Numarası:</th>
                                <td><strong>@Model.RequestNumber</strong></td>
                            </tr>
                            <tr>
                                <th>Başlık:</th>
                                <td>@Model.Title</td>
                            </tr>
                            <tr>
                                <th>Açıklama:</th>
                                <td>@Model.Description</td>
                            </tr>
                            <tr>
                                <th>Kategori:</th>
                                <td>@Model.Category?.Name</td>
                            </tr>
                            <tr>
                                <th>Vatandaş:</th>
                                <td>@Model.User?.FirstName @Model.User?.LastName (@Model.User?.Email)</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Durum Bilgileri</h5>
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">Gönderilme:</th>
                                <td>@Model.SubmittedAt.ToString("dd.MM.yyyy HH:mm")</td>
                            </tr>
                            @if (Model.AssignedAt.HasValue)
                            {
                                <tr>
                                    <th>Atanma:</th>
                                    <td>@Model.AssignedAt.Value.ToString("dd.MM.yyyy HH:mm")</td>
                                </tr>
                            }
                            @if (Model.SLADeadline.HasValue)
                            {
                                <tr>
                                    <th>Hedef Çözüm Tarihi:</th>
                                    <td>
                                        @Model.SLADeadline.Value.ToString("dd.MM.yyyy HH:mm")
                                        @if (Model.IsSLABreached)
                                        {
                                            <span class="badge bg-danger ms-2">Süre Aşıldı</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </table>
                    </div>
                </div>

                @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
                {
                    <div class="mb-4">
                        <h5>Konum</h5>
                        <p><strong>Adres:</strong> @Model.Address</p>
                        <div id="map" style="height: 300px; width: 100%; border: 1px solid #ddd; border-radius: 5px;"></div>
                    </div>
                }

                <hr />

                <div class="row">
                    <div class="col-md-6">
                        <h5>Durum Güncelle</h5>
                        <form asp-action="UpdateStatus" method="post" class="mb-3">
                            <input type="hidden" name="requestId" value="@Model.RequestId" />
                            <div class="mb-2">
                                <select name="statusId" class="form-select" required>
                                    @foreach (var status in ViewBag.Statuses)
                                    {
                                        <option value="@status.StatusId" selected="@(status.StatusId == Model.StatusId)">
                                            @status.Name
                                        </option>
                                    }
                                </select>
                            </div>
                            <div class="mb-2">
                                <textarea name="comment" class="form-control" rows="2" placeholder="Yorum (opsiyonel)"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-arrow-repeat"></i> Durumu Güncelle
                            </button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <h5>Görev Ata</h5>
                        <form asp-action="Assign" method="post" class="mb-3">
                            <input type="hidden" name="requestId" value="@Model.RequestId" />
                            <div class="mb-2">
                                <select name="assignedToUserId" class="form-select" required>
                                    <option value="">-- Personel Seçiniz --</option>
                                    @foreach (var user in ViewBag.Users)
                                    {
                                        <option value="@user.UserId">
                                            @user.FirstName @user.LastName
                                        </option>
                                    }
                                </select>
                            </div>
                            <div class="mb-2">
                                <textarea name="notes" class="form-control" rows="2" placeholder="Notlar (opsiyonel)"></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-person-check"></i> Görev Ata
                            </button>
                        </form>
                    </div>
                </div>

                <hr />

                <div class="mb-4">
                    <h5>Yorum Ekle</h5>
                    <form asp-action="AddComment" method="post">
                        <input type="hidden" name="requestId" value="@Model.RequestId" />
                        <div class="mb-2">
                            <textarea name="comment" class="form-control" rows="3" placeholder="Yorumunuzu yazınız" required></textarea>
                        </div>
                        <div class="mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="isInternal" value="true" id="isInternal">
                                <label class="form-check-label" for="isInternal">
                                    İç not (vatandaş göremez)
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-info">
                            <i class="bi bi-chat-dots"></i> Yorum Ekle
                        </button>
                    </form>
                </div>

                <div class="mb-4">
                    <h5>Güncellemeler</h5>
                    <div class="timeline">
                        @foreach (var update in Model.Updates.OrderByDescending(u => u.CreatedAt))
                        {
                            <div class="card mb-2 @(update.IsInternal ? "bg-light" : "")">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <strong>@update.User?.FirstName @update.User?.LastName</strong>
                                        <small class="text-muted">@update.CreatedAt.ToString("dd.MM.yyyy HH:mm")</small>
                                    </div>
                                    @if (update.IsInternal)
                                    {
                                        <span class="badge bg-secondary">İç Not</span>
                                    }
                                    <p class="mb-0 mt-2">@update.Comment</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a asp-action="Index" class="btn btn-secondary">Geri Dön</a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @if (Model.Latitude.HasValue && Model.Longitude.HasValue)
    {
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Use .ToString() with InvariantCulture for decimal values in JavaScript to avoid comma issues
                var lat = @Model.Latitude.Value.ToString(System.Globalization.CultureInfo.InvariantCulture);
                var lon = @Model.Longitude.Value.ToString(System.Globalization.CultureInfo.InvariantCulture);

                var map = L.map('map').setView([lat, lon], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                
                L.marker([lat, lon]).addTo(map)
                    .bindPopup('@Html.Raw(Model.Address?.Replace("'", "\\'"))').openPopup();
            });
        </script>
    }
}
